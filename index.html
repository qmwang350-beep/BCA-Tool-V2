<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCA è›‹ç™½è´¨æµ“åº¦è®¡ç®—å™¨ & ä¸Šæ ·åŠ©æ‰‹</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            background-color: #f4f7f9;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #007bff;
            text-align: center;
            margin-bottom: 5px;
        }
        .lab-info {
            text-align: center;
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 20px;
        }
        .header-placeholder {
            text-align: center;
            font-size: 4em;
            margin: 15px 0;
            color: #007bff;
        }
        h2 {
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            margin-top: 25px;
            color: #555;
        }
        .input-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .input-box {
            flex: 1;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        textarea {
            width: 100%;
            height: 100px; 
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
        }
        .conc-list {
            font-family: 'Consolas', 'Courier New', monospace;
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            word-break: break-all;
        }
        .control-panel {
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 20px;
            align-items: center;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .control-panel > div {
            padding: 5px 0;
        }
        .control-panel label {
            font-weight: bold;
        }

        button#calculateBtn {
            width: 100%;
            padding: 12px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 10px;
        }
        button#calculateBtn:hover {
            background-color: #218838;
        }
        .results {
            margin-top: 30px;
            padding: 20px;
            background-color: #e9ecef;
            border-radius: 6px;
        }
        .results h3 {
            color: #007bff;
        }
        .results-placeholder {
            text-align: center;
            font-size: 3em;
            margin-bottom: 15px;
            color: #555;
        }
        #sampleResultsTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-family: 'Consolas', 'Courier New', monospace;
        }
        #sampleResultsTable th, #sampleResultsTable td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
        #sampleResultsTable th {
            background-color: #d8e5f2;
            color: #333;
        }
        .warning {
            color: red;
            font-weight: bold;
        }
        .r-squared {
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ”¬ BCA è›‹ç™½è´¨æµ“åº¦è®¡ç®—å™¨ & ä¸Šæ ·åŠ©æ‰‹</h1>
    <p class="lab-info">Lu Lab WQM åˆ¶ä½œ</p>
    
    <div class="header-placeholder">ğŸ§ªğŸŒ¡ï¸ğŸ“Š</div>
    

    <h2>1. æ ‡å‡†æ›²çº¿æ•°æ®è¾“å…¥</h2>
    <div class="input-section">
        <div class="input-box">
            <h3>æ ‡å‡†å“æµ“åº¦ (mg/mL)</h3>
            <p>é¢„è®¾ 8 ä¸ªæµ“åº¦ï¼Œ**è¯·å‹¿ä¿®æ”¹**ï¼š</p>
            <div id="standardConcs" class="conc-list">
                0.0, 0.125, 0.25, 0.5, 0.75, 1.0, 1.5, 2.0
            </div>
        </div>
        
        <div class="input-box">
            <h3>æ ‡å‡†å“ OD å€¼ (562 nm)</h3>
            <p>è¯·ç²˜è´´ 8 ä¸ª OD å€¼ (æ¨ªæ’/é€—å·/ç©ºæ ¼åˆ†éš”)ï¼š</p>
            <textarea id="standardOdTextarea" placeholder="ä¾‹å¦‚: 0.1938, 0.234, 0.2864, 0.3883, 0.4913, 0.5838, 0.754, 0.9547"></textarea>
        </div>
    </div>

    <h2>2. æ ·å“ä¸Šæ ·é…æ–¹è®¾ç½®</h2>
    <div class="control-panel">
        <div>
            <label for="dilutionFactor">æ ·å“ç¨€é‡Šå€æ•°:</label>
            <input type="number" step="1" id="dilutionFactor" value="1" style="width: 100%; padding: 8px;">
        </div>
        <div>
            <label for="targetLoadAmount">ç›®æ ‡ä¸Šæ ·é‡ (Î¼g):</label>
            <input type="number" step="1" id="targetLoadAmount" value="20" style="width: 100%; padding: 8px;">
        </div>
        <div>
            <label for="proteinRecipeVolume">è›‹ç™½é…æ–¹ä½“ç§¯ (Î¼L):</label>
            <input type="number" step="1" id="proteinRecipeVolume" value="40" style="width: 100%; padding: 8px;">
        </div>
        <div>
            <label for="lbRecipeVolume">Loading Buffer ä½“ç§¯ (Î¼L):</label>
            <input type="number" step="1" id="lbRecipeVolume" value="10" style="width: 100%; padding: 8px;">
        </div>
    </div>
    
    <div class="input-box">
        <label for="sampleOdTextarea">å¾…æµ‹æ ·å“ OD å€¼:</label>
        <p>è¯·ç²˜è´´**å¤šè¡Œ**å¾…æµ‹æ ·å“çš„ OD å€¼ (æ¨ªæ’/é€—å·/ç©ºæ ¼/æ¢è¡Œåˆ†éš”)ï¼š</p>
        <textarea id="sampleOdTextarea" placeholder="ä¾‹å¦‚: 0.373, 0.501, 0.812, 0.450 ... æˆ–å¤šè¡Œç²˜è´´"></textarea>
    </div>

    <button id="calculateBtn">æ‰¹é‡è®¡ç®—å¹¶ç”Ÿæˆä¸Šæ ·é…æ–¹</button>

    <div class="results" id="results">
        <h2>è®¡ç®—ç»“æœ</h2>
        <div class="results-placeholder">ğŸ’§ğŸ’‰ğŸ§ª</div>
        <p>è¯·ç²˜è´´æ•°æ®å¹¶ç‚¹å‡»è®¡ç®—æŒ‰é’®ã€‚</p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('calculateBtn').addEventListener('click', calculateBCA);
    });

    /**
     * æ ¸å¿ƒè®¡ç®—é€»è¾‘ï¼šæœ€å°äºŒä¹˜æ³•çº¿æ€§å›å½’
     */
    function linearRegression(X, Y) {
        const n = X.length;
        if (n !== Y.length || n < 2) {
            return null;
        }

        let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
        for (let i = 0; i < n; i++) {
            sumX += X[i];
            sumY += Y[i];
            sumXY += X[i] * Y[i];
            sumXX += X[i] * X[i];
        }

        const avgX = sumX / n;
        const avgY = sumY / n;

        // æ–œç‡ (m)
        const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
        
        // æˆªè· (b)
        const intercept = avgY - slope * avgX;

        // R^2 (ç”¨äºè¯„ä¼°æ‹Ÿåˆä¼˜åº¦)
        let ssTotal = 0;
        let ssResidual = 0;
        for (let i = 0; i < n; i++) {
            const predictedY = slope * X[i] + intercept;
            ssTotal += (Y[i] - avgY) ** 2;
            ssResidual += (Y[i] - predictedY) ** 2;
        }
        const rSquared = 1 - (ssResidual / ssTotal);

        return { slope, intercept, rSquared };
    }

    /**
     * å¢å¼ºçš„æ–‡æœ¬è§£æå‡½æ•°ï¼šæ”¯æŒé€—å·ã€ç©ºæ ¼æˆ–æ¢è¡Œåˆ†éš”
     */
    function parseValues(text) {
        return text.replace(/[\s,]+/g, ' ') 
            .trim()
            .split(' ')
            .map(line => parseFloat(line))
            .filter(n => !isNaN(n) && n !== ''); 
    }


    // ä¸»è®¡ç®—å‡½æ•°
    function calculateBCA() {
        const standardConcStr = document.getElementById('standardConcs').textContent.trim();
        const standardOdText = document.getElementById('standardOdTextarea').value;
        const sampleOdText = document.getElementById('sampleOdTextarea').value;
        
        const dilutionFactor = parseFloat(document.getElementById('dilutionFactor').value) || 1;
        const targetLoadAmount_ug = parseFloat(document.getElementById('targetLoadAmount').value);
        
        const proteinRecipeVolume_uL = parseFloat(document.getElementById('proteinRecipeVolume').value); // V_protein_recipe
        const lbRecipeVolume_uL = parseFloat(document.getElementById('lbRecipeVolume').value); // V_LB_recipe


        if (isNaN(targetLoadAmount_ug) || targetLoadAmount_ug <= 0) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç›®æ ‡ä¸Šæ ·é‡ (Î¼g)ã€‚');
            return;
        }
        if (isNaN(proteinRecipeVolume_uL) || proteinRecipeVolume_uL <= 0 || isNaN(lbRecipeVolume_uL) || lbRecipeVolume_uL < 0) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è›‹ç™½é…æ–¹ä½“ç§¯å’Œ Loading Buffer ä½“ç§¯ã€‚');
            return;
        }

        const totalRecipeVolume_uL = proteinRecipeVolume_uL + lbRecipeVolume_uL;
        const dilutionRatio = proteinRecipeVolume_uL / totalRecipeVolume_uL; // D = V_protein / V_total

        
        // é¢„è®¾æµ“åº¦ (Xè½´æ•°æ®)
        const X_concs = standardConcStr.split(',').map(s => parseFloat(s.trim()));
        
        // æå–å¹¶æ¸…ç†æ ‡å‡†æ›²çº¿ OD å€¼ (Yè½´æ•°æ®)
        const Y_ods = parseValues(standardOdText);

        if (Y_ods.length !== X_concs.length) {
            alert(`æ ‡å‡†æ›²çº¿ OD å€¼æ•°é‡é”™è¯¯ã€‚éœ€è¦ ${X_concs.length} ä¸ª OD å€¼ï¼Œä½†æ‚¨ç²˜è´´äº† ${Y_ods.length} ä¸ªæœ‰æ•ˆå€¼ã€‚`);
            return;
        }
        if (Y_ods.length < 2) {
             alert('æ ‡å‡†æ›²çº¿ OD å€¼æ•°é‡ä¸è¶³ 2 ä¸ªã€‚');
            return;
        }

        // 1. è¿›è¡Œçº¿æ€§å›å½’è®¡ç®—
        const regression = linearRegression(X_concs, Y_ods);
        if (!regression) {
            alert('æ ‡å‡†æ›²çº¿æ•°æ®æ‹Ÿåˆå¤±è´¥ï¼Œè¯·ç¡®ä¿è‡³å°‘æœ‰ä¸¤ç»„æœ‰æ•ˆçš„ OD å€¼ã€‚');
            return;
        }

        const { slope, intercept, rSquared } = regression;
        
        if (Math.abs(slope) < 1e-6) {
            alert('è®¡ç®—å¾—åˆ°çš„æ–œç‡ m æ¥è¿‘é›¶ï¼Œæ— æ³•è¿›è¡Œæœ‰æ•ˆè®¡ç®—ã€‚');
            return;
        }

        // ç¡®å®š OD å€¼çš„æœ‰æ•ˆèŒƒå›´
        const minOd = Math.min(...Y_ods);
        const maxOd = Math.max(...Y_ods);
        
        // 2. æå–å¹¶æ¸…ç†å¾…æµ‹æ ·å“ OD å€¼
        const sampleOds = parseValues(sampleOdText);

        if (sampleOds.length === 0) {
            alert('è¯·åœ¨å¾…æµ‹æ ·å“ OD æ–‡æœ¬æ¡†ä¸­ç²˜è´´ OD å€¼ã€‚');
            return;
        }
        
        // 3. æ‰¹é‡è®¡ç®—ç»“æœ
        const results = sampleOds.map((od, index) => {
            // C1 (å®é™…æµ“åº¦) = C_uncorrected * ç¨€é‡Šå€æ•° (mg/mL)
            const uncorrectedConc_mg_ml = (od - intercept) / slope; // mg/mL
            const C1_mg_ml = uncorrectedConc_mg_ml * dilutionFactor; // C1 (å®é™…æµ“åº¦)

            // C2 (ç¨€é‡Šåæµ“åº¦) = C1 * D (mg/mL)
            const C2_mg_ml = C1_mg_ml * dilutionRatio; 
            
            let V_final_uL = NaN;
            let V_protein_needed_uL = NaN;
            let V_lb_needed_uL = NaN;

            if (C2_mg_ml > 0) {
                // 1 mg/mL = 1 ug/uL
                // V_final (æ€»æ··åˆä½“ç§¯) = ç›®æ ‡ä¸Šæ ·é‡ (ug) / C2 (ug/uL)
                V_final_uL = targetLoadAmount_ug / C2_mg_ml; 
                
                // V_protein_needed = V_final * D
                V_protein_needed_uL = V_final_uL * dilutionRatio;

                // V_lb_needed = V_final - V_protein_needed
                V_lb_needed_uL = V_final_uL - V_protein_needed_uL;

            } else {
                 V_final_uL = NaN;
            }
            
            let warning = '';
            if (od < minOd || od > maxOd) {
                warning = `(å¤–æ¨)`;
            }
            
            return {
                sampleIndex: index + 1,
                od: od,
                C1_mg_ml: C1_mg_ml,
                C2_mg_ml: C2_mg_ml,
                V_final_uL: V_final_uL,
                V_protein_needed_uL: V_protein_needed_uL,
                V_lb_needed_uL: V_lb_needed_uL,
                warning: warning
            };
        });

        // 4. æ˜¾ç¤ºç»“æœ
        const resultsDiv = document.getElementById('results');
        
        // åˆ›å»ºè¡¨æ ¼ HTML
        let tableHtml = `
            <h2>è®¡ç®—ç»“æœ</h2>
            <div class="results-placeholder">ğŸ’§ğŸ’‰ğŸ§ª</div>
            <h3>æ‹Ÿåˆç»“æœ</h3>
            <p class="r-squared">çº¿æ€§å›å½’æ–¹ç¨‹: OD = ${slope.toFixed(4)} * æµ“åº¦(mg/mL) + ${intercept.toFixed(4)}</p>
            <p class="r-squared">ç›¸å…³ç³»æ•° RÂ²: <strong>${rSquared.toFixed(4)}</strong> ${rSquared < 0.99 ? '<span class="warning">(RÂ²è¾ƒä½!)</span>' : ''}</p>
            <hr>
            <h3>æ ·å“ä¸Šæ ·é…æ–¹ (ç¨€é‡Šå€æ•°: ${dilutionFactor} | ç›®æ ‡ä¸Šæ ·é‡: ${targetLoadAmount_ug} Î¼g)</h3>
            <p><strong>ä¸Šæ ·é…æ–¹æ¯”ä¾‹:</strong> ${proteinRecipeVolume_uL} Î¼L è›‹ç™½ : ${lbRecipeVolume_uL} Î¼L LB (ç¨€é‡Šç³»æ•°D=${dilutionRatio.toFixed(3)})</p>
            <table id="sampleResultsTable">
                <thead>
                    <tr>
                        <th>æ ·å“ç¼–å·</th>
                        <th>C1 (å®é™…æµ“åº¦, mg/mL)</th>
                        <th>C2 (ç¨€é‡Šåæµ“åº¦, mg/mL)</th>
                        <th>æ‰€éœ€è›‹ç™½ä½“ç§¯ (Î¼L)</th>
                        <th>æ‰€éœ€ Loading Buffer (Î¼L)</th>
                        <th>æ€»æ··åˆä½“ç§¯ (Î¼L)</th>
                    </tr>
                </thead>
                <tbody>
        `;

        results.forEach(item => {
            const concColor = item.warning.includes('å¤–æ¨') ? 'class="warning"' : '';
            
            // --- æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œï¼štoFixed(1) ---
            const V_p_display = isNaN(item.V_protein_needed_uL) || item.V_protein_needed_uL < 0 ? 'æµ“åº¦æ— æ•ˆ' : item.V_protein_needed_uL.toFixed(1);
            const V_lb_display = isNaN(item.V_lb_needed_uL) || item.V_lb_needed_uL < 0 ? '-' : item.V_lb_needed_uL.toFixed(1);
            const V_final_display = isNaN(item.V_final_uL) || item.V_final_uL < 0 ? '-' : item.V_final_uL.toFixed(1);
            
            // è­¦å‘Šï¼šå¦‚æœæ‰€éœ€ä½“ç§¯è¿‡å¤§ï¼ˆä¾‹å¦‚è¶…è¿‡ 50 Î¼Lï¼‰ï¼Œåˆ™æ ‡çº¢
            const V_warning = item.V_final_uL > 50 ? 'class="warning"' : '';

            tableHtml += `
                <tr>
                    <td>æ ·å“ ${item.sampleIndex}</td>
                    <td ${concColor}>
                        <strong>${item.C1_mg_ml.toFixed(4)}</strong>
                        ${item.warning.includes('å¤–æ¨') ? `<br><small class="warning">${item.warning}</small>` : ''}
                    </td>
                    <td>
                        <strong>${item.C2_mg_ml.toFixed(4)}</strong>
                    </td>
                    <td ${V_warning}>
                        <strong>${V_p_display}</strong>
                    </td>
                    <td ${V_warning}>
                        <strong>${V_lb_display}</strong>
                    </td>
                    <td ${V_warning}>
                        <strong>${V_final_display}</strong>
                        ${item.V_final_uL > 50 ? `<br><small class="warning">(ä½“ç§¯è¿‡å¤§)</small>` : ''}
                    </td>
                </tr>
            `;
        });

        tableHtml += `
                </tbody>
            </table>
            <p style="margin-top:15px;"><small>æ³¨æ„ï¼š'C1 (å®é™…æµ“åº¦)' æ˜¯æ ·å“åŸå§‹æµ“åº¦ã€‚'C2 (ç¨€é‡Šåæµ“åº¦)' æ˜¯ ${proteinRecipeVolume_uL} Î¼L è›‹ç™½åŠ å…¥ ${lbRecipeVolume_uL} Î¼L Loading Buffer åçš„è›‹ç™½æµ“åº¦ã€‚æœ€åä¸‰åˆ—ä½“ç§¯ï¼ˆÎ¼Lï¼‰æ˜¯æ‚¨éœ€è¦å¸å–è¿›è¡Œä¸Šæ ·çš„é…æ–¹ã€‚</small></p>
        `;

        resultsDiv.innerHTML = tableHtml;
    }
</script>

</body>
</html>